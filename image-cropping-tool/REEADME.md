---

# 基于模板匹配的智能图片裁剪工具 (SIFT Auto Cropper)

这是一个基于 Python OpenCV 的自动化图像处理工具。它利用 **SIFT (尺度不变特征变换)** 算法，根据提供的“模板图片”，在“原图”中自动定位匹配区域，并按特定比例裁剪出高分辨率图片及固定尺寸缩略图。

## ✨ 主要功能

1.  **智能定位**：使用 SIFT 特征点匹配和单应性矩阵（Homography）变换，即使原图中的目标发生了旋转、缩放或轻微形变，也能精准定位。
2.  **双重输出**：
    *   **高分原图裁剪** (`output_high_res`)：保留原图分辨率的裁剪区域，画质无损。
    *   **固定尺寸图** (`output_fixed_456x564`)：将裁剪区域自动调整为 **456x564** 像素，适合统一展示。
3.  **自动比例修正**：根据匹配到的区域高度，自动计算并锁定 **456:564 (约 0.8085)** 的宽高比进行裁剪，确保构图居中。
4.  **批量处理**：支持对文件夹内的图片进行批量自动匹配和处理。

## 🛠️ 环境依赖

在使用本工具前，请确保已安装 Python 环境，并安装以下依赖库：

```bash
pip install opencv-python numpy
```
*注意：本工具使用了 `cv2.SIFT_create()`，请确保 `opencv-python` 版本不低于 3.4.2 (建议安装最新版，如 4.x)。*

## 📂 文件目录结构

为了让脚本正常工作，请在脚本所在目录建立以下文件夹结构：

```text
Project_Root/
│
├── image-cropping.py      # 本脚本文件
├── templates/             # [输入] 放置参考模板图片 (150x210半身像小图)
├── input_images/          # [输入] 放置待处理的高清原图 (不要直接放入超级大的原图)
├── output_high_res/       # [输出] 脚本自动生成，存放高分裁剪图
└── output_fixed_456x564/  # [输出] 脚本自动生成，存放 456x564 规格图
```

## 🚀 使用方法

1.  **准备素材**：
    *   将你想要裁剪的目标样图（模板）放入 `templates` 文件夹。
    *   将含有该目标的原始高清大图放入 `input_images` 文件夹。
2.  **命名规则**：
    *   脚本会提取模板文件的文件名（不含扩展名），去原图文件夹中搜索**包含该文件名**的原图。
    *   **示例**：
        *   模板文件：`洁尔佩塔.png`
        *   原图文件：`洁尔佩塔带背景.png`
        *   *结果：匹配成功。*
3.  **运行脚本**：
    ```bash
    python image-cropping
    ```
4.  **查看结果**：
    *   运行完成后，检查 `output_high_res` 和 `output_fixed_456x564` 文件夹查看生成结果。

## ⚙️ 核心逻辑说明

1.  **特征提取**：将原图和模板转换为灰度图，使用 SIFT 算法提取关键点（Keypoints）和描述符（Descriptors）。
2.  **特征匹配**：使用 KNN (K-Nearest Neighbors) 算法进行特征点匹配，并通过比率测试（Lowe's ratio test）过滤掉低质量的匹配点。
3.  **透视变换**：如果有效匹配点超过 10 个，计算单应性矩阵，确定模板在原图中的四个角点坐标。
4.  **中心裁剪**：
    *   计算匹配区域的中心点。
    *   读取匹配区域的高度 (`final_h`)。
    *   根据目标宽高比 (456/564) 计算目标宽度 (`final_w`)。
    *   以中心点为基准，向外扩展裁剪框。
5.  **边界保护**：如果计算出的裁剪框超出了原图边界，脚本会自动平移裁剪框以尽量保留图像内容，同时确保不越界。
6.  **输出重绘**：使用 Lanczos4 插值法将图像缩放至最终的 456x564 分辨率。

## ⚠️ 常见问题与排错

*   **输出显示“失败(匹配点不足)”**：
    *   原因：模板图片与原图差异过大（如角度过于极端、光照差异巨大），或者模板图片过于模糊，导致 SIFT 无法找到足够的特征点（少于10个）。
    *   解决：尝试使用更清晰的模板，或截取原图中更具特征的一部分作为模板。
*   **找不到原图**：
    *   请检查 `templates` 中的文件名是否包含在 `input_images` 的文件名中。文件名区分大小写（取决于操作系统）。
*   **裁剪位置不准**：
    *   如果原图中存在多个相似物体（如重复的图案），SIFT 可能会误匹配到错误的位置。

## 📝 配置修改

如果你想修改输出尺寸，请在代码中找到以下部分进行修改：

```python
target_w, target_h = 456, 564  # 修改为你想要的宽和高
```

---