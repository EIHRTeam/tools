name: Auto Package and Release

on:
  push:
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    env:
      TAG_NAME: auto-release-${{ github.run_id }}
      RELEASE_NAME: Auto release ${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect added files
        id: detect
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            RANGE="${{ github.sha }}"
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi
          echo "Diff range: $RANGE"
          ADDED=$(git diff --name-status $RANGE | awk '$1=="A"{print $2; exit}')
          if [ -n "$ADDED" ]; then
            echo "has_added=true" >> $GITHUB_OUTPUT
          else
            echo "has_added=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no added files
        if: steps.detect.outputs.has_added == 'false'
        run: |
          echo "No added files in this push. Exiting."
          exit 0

      - name: Package root subdirectories
        id: package
        run: |
          mkdir -p $GITHUB_WORKSPACE/zips
          ZIPS=""
          for d in */ ; do
            if [ -d "$d" ]; then
              dirname=${d%/}
              if [ "$dirname" = ".github" ]; then
                continue
              fi
              zip -r "$GITHUB_WORKSPACE/zips/${dirname}.zip" "$dirname" -x "*/.git/*"
              ZIPS="$ZIPS $GITHUB_WORKSPACE/zips/${dirname}.zip"
            fi
          done
          echo "zips<<EOF" >> $GITHUB_OUTPUT
          echo "$ZIPS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Read release notes if present
        id: notes
        run: |
          if [ -f RELEASE_NOTES.md ]; then
            echo "body<<EOF" >> $GITHUB_OUTPUT
            cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "Auto release created by workflow." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create release and upload assets
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const zips = (process.env.ZIPS || '').trim();
            const zipList = zips ? zips.split(/\s+/) : [];
            const body = process.env.RELEASE_BODY || '';
            const tag = process.env.TAG_NAME || `auto-release-${process.env.GITHUB_RUN_ID}`;
            const name = process.env.RELEASE_NAME || tag;
            const release = await github.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: name,
              body: body,
              draft: false,
              prerelease: false,
            });
            for (const filePath of zipList){
              if(!filePath) continue;
              const content = fs.readFileSync(filePath);
              const fname = path.basename(filePath);
              await github.repos.uploadReleaseAsset({
                url: release.data.upload_url,
                headers: {
                  "content-type": "application/zip",
                  "content-length": content.length
                },
                name: fname,
                data: content
              });
            }
        env:
          ZIPS: ${{ steps.package.outputs.zips }}
          RELEASE_BODY: ${{ steps.notes.outputs.body }}
          TAG_NAME: ${{ env.TAG_NAME }}
          RELEASE_NAME: ${{ env.RELEASE_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
