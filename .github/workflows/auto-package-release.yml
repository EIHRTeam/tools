name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - '**'
  workflow_dispatch:
    inputs:
      release_body:
        description: 'Release 内容描述 (可选，若存在模板则忽略)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码（需要完整历史）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 生成 Release Tag（版本规则重构）
      - name: Generate Release Tag
        id: tag
        run: |
          set -e

          # ---------- 基础准备 ----------
          # 处理初始提交
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            PREV_COMMIT="HEAD^"
          else
            PREV_COMMIT="4b825dc642cb6eb9a060e54bf8d69288fbee4904"
          fi

          # 当前与历史目录
          CURRENT_DIRS=$(find . -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' \
            | sed 's|^\./||' \
            | grep -v '^discarded$' \
            | grep -v '^\.github$' \
            | sort)

          PREV_DIRS=$(git ls-tree -d --name-only $PREV_COMMIT \
            | grep -v '^discarded$' \
            | grep -v '^\.github$' \
            | sort)

          NEW_DIRS=$(comm -23 <(echo "$CURRENT_DIRS") <(echo "$PREV_DIRS"))

          # 文件变更检测（排除目录新增）
          CHANGED_FILES=$(git diff --name-only $PREV_COMMIT HEAD --diff-filter=AM \
            | grep -v '^\.github/' || true)

          # ---------- 获取最近版本 ----------
          LATEST_VERSION=$(git describe --tags --match "[0-9]*.[0-9]*.[0-9]*" --abbrev=0 2>/dev/null || echo "1.0.0")
          VERSION=${LATEST_VERSION#v}

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # ---------- 版本递增规则 ----------
          if [ -n "$NEW_DIRS" ]; then
            echo "检测到新目录：$NEW_DIRS"
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ -n "$CHANGED_FILES" ]; then
            echo "检测到文件变更"
            PATCH=$((PATCH + 1))
          else
            echo "无有效变更，使用原版本号"
          fi

          FINAL_TAG="${MAJOR}.${MINOR}.${PATCH}"
          echo "最终 Release Tag: $FINAL_TAG"

          echo "release_tag=$FINAL_TAG" >> $GITHUB_OUTPUT

      # 3. 打包子目录（.runtime 失败即 workflow 失败）
      - name: Zip Subdirectories
        run: |
          set -e

          mkdir -p release_artifacts

          find . -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' \
            | grep -v '^\./\.github' \
            | grep -v '^\./discarded$' \
            | while read dir; do

            dirname=$(basename "$dir")
            echo "----------------------------------------"
            echo "处理目录: $dirname"

            # 标准包
            zip -r "release_artifacts/${dirname}.zip" "$dirname"

            # Full 包逻辑
            if [ -f "$dirname/.runtime" ]; then
              echo "发现 .runtime，构建 Full 包"

              TEMP_ROOT="temp_full_build"
              rm -rf "$TEMP_ROOT"
              mkdir -p "$TEMP_ROOT/$dirname"

              cp -r "$dirname/"* "$TEMP_ROOT/$dirname/"

              grep -v '^#' "$dirname/.runtime" | grep -v '^\s*$' | tr -d '\r' | while read -r url; do
                filename=$(basename "$url")
                echo "下载依赖: $filename"

                curl -L -sS -f -o "$TEMP_ROOT/$dirname/$filename" "$url"
              done

              pushd "$TEMP_ROOT" > /dev/null
              zip -r "../release_artifacts/${dirname}-full.zip" "$dirname"
              popd > /dev/null

              rm -rf "$TEMP_ROOT"
            fi
          done

          echo "打包完成"
          ls -l release_artifacts/

      # 4. 创建 Release（使用模板）
      - name: Load Release Template
        id: release_body
        run: |
          if [ -f ".github/release-template.md" ]; then
            echo "body<<EOF" >> $GITHUB_OUTPUT
            cat .github/release-template.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "body=Auto-generated release." >> $GITHUB_OUTPUT
          fi

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Release ${{ steps.tag.outputs.release_tag }}
          body: ${{ steps.release_body.outputs.body }}
          draft: false
          prerelease: false
          files: release_artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
