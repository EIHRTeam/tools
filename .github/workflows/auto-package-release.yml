name: Auto Pack and Release

# 触发条件配置
on:
  # 1. 当有代码推送到 main 分支时自动触发
  push:
    branches:
      - main  # 如果你的主分支叫 master，请修改这里
    paths:
      - '**'  # 监听所有文件变化

  # 2. 允许手动触发 (在 GitHub Actions 页面点击 Run workflow)
  workflow_dispatch:
    inputs:
      release_body:
        description: 'Release 内容描述 (可选)'
        required: false
        default: 'Auto-generated release from GitHub Actions'

# 权限配置：需要写入权限来创建 Release
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 第一步：检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 第二步：打包所有子目录
      - name: Zip Subdirectories
        run: |
          # 创建一个临时目录存放 zip 文件
          mkdir -p release_artifacts

          # 遍历当前目录下的所有子目录
          # find . -maxdepth 1 -mindepth 1 -type d: 查找当前层级下的目录
          # -not -path '*/.*': 排除隐藏目录 (如 .git)
          # grep -v '^\./\.github': 排除 .github 目录
          
          find . -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' | grep -v '^\./\.github' | while read dir; do
            dirname=$(basename "$dir")
            echo "正在打包目录: $dirname"
            
            # 将目录打包为 zip，存放在 release_artifacts 文件夹中
            zip -r "release_artifacts/${dirname}.zip" "$dirname"
          done

          echo "打包完成，文件列表如下："
          ls -l release_artifacts/

      # 第三步：生成 Release 的标签名 (使用时间戳，避免重复)
      - name: Generate Release Tag
        id: tag
        run: |
          # 生成格式如: release-20231027-143000
          echo "release_tag=release-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      # 第四步：创建 Release 并上传文件
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Release ${{ steps.tag.outputs.release_tag }}
          # 如果是手动触发，使用输入的描述；如果是自动触发，使用默认描述
          body: ${{ github.event.inputs.release_body || 'New content detected. Auto-packaged release.' }}
          draft: false
          prerelease: false
          # 上传 release_artifacts 目录下的所有 zip 文件
          files: release_artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}